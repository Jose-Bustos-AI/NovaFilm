ğŸ‰ FelicitaciÃ³n

Â¡Buen trabajo! Ahora el checkout funciona, los webhooks llegan bien, se asignan los crÃ©ditos correctos y se muestra el plan activo con su fecha de renovaciÃ³n. Gran avance ğŸ‘

ğŸ§  Contexto (lo que pasa ahora)

En Mi Cuenta se ve: Plan activo: Pro y Renueva el 4/10/2025.

Los crÃ©ditos se acreditan bien (ya no hay duplicados).

Al pulsar Cancelar SuscripciÃ³n aparece un error 400:

Consola del navegador: POST /api/billing/cancel â†’ 400 (Bad Request)

Mensaje: {"error":"No active subscription found"}

ConclusiÃ³n: el backend no estÃ¡ localizando la suscripciÃ³n de Stripe para cancelarla.

ğŸ›¡ï¸ Regla de oro

No rompas nada de lo que ya funciona:

No tocar la lÃ³gica de crÃ©ditos (ni duplicar).

Mantener idempotencia del webhook y la tabla stripe_events.

Mantener el estado â€œplan activoâ€ y â€œrenovaciÃ³nâ€ correcto.

CancelaciÃ³n a fin de perÃ­odo (no borrar crÃ©ditos existentes).

No bloquear la generaciÃ³n de videos si el usuario aÃºn tiene crÃ©ditos.

âœ… Instrucciones (paso a paso)
1) Persistir el subscription_id de Stripe en el usuario

AÃ±ade en la tabla users el campo (si no existe): stripe_subscription_id TEXT NULL.

En los webhooks, guarda siempre el subscription_id del usuario:

checkout.session.completed: tomar session.subscription y guardarlo en users.stripe_subscription_id (junto con stripe_customer_id si aÃºn no estÃ¡).

invoice.payment_succeeded: si llega invoice.subscription y el usuario no tiene stripe_subscription_id, guÃ¡rdalo tambiÃ©n.

customer.subscription.deleted: vaciar stripe_subscription_id, vaciar active_plan y **credits_renew_at`.

Nota: mantener idempotencia usando stripe_events para no reescribir estados dos veces.

2) Arreglar el endpoint POST /api/billing/cancel

LÃ³gica:

Buscar al usuario autenticado.

Si users.stripe_subscription_id existe â†’ usar ese id para cancelar.

Si no existe, hacer fallback robusto:

Listar suscripciones del stripe_customer_id con status IN ['active','trialing','past_due','unpaid'].

Tomar la mÃ¡s reciente y usar su id.

Llamar a Stripe para cancelar al final del perÃ­odo (cancel_at_period_end = true).

No borres active_plan ni credits_renew_at aquÃ­ (siguen vigentes hasta el final). Ese borrado lo hace el webhook customer.subscription.deleted.

Responder 200 { ok: true, cancelAtPeriodEnd: true }.

Manejo de errores:

Si no se encuentra suscripciÃ³n en Stripe â†’ 404 { error: 'No active subscription on Stripe' }

Si el usuario no tiene stripe_customer_id â†’ 400 { error: 'Missing stripe customer' }

Logging:

billing> CANCEL REQUEST: userId=..., customerId=..., subscriptionId=...

billing> CANCEL RESULT: cancel_at_period_end=true, status=...

3) Webhook de cancelaciÃ³n

En customer.subscription.deleted:

Poner users.active_plan = NULL

users.credits_renew_at = NULL

users.stripe_subscription_id = NULL

Registrar evento en credits_ledger (opcional: â€œsuscripciÃ³n cancelada / fin de perÃ­odoâ€).

4) UI de Mi Cuenta (mÃ­nimo cambio)

BotÃ³n Cancelar SuscripciÃ³n:

Llama a POST /api/billing/cancel.

Con 200: mostrar toast â€œTu suscripciÃ³n se cancelarÃ¡ al final del periodo. PodrÃ¡s usar los crÃ©ditos restantes hasta entonces.â€

No ocultar el plan activo aÃºn (sigue vigente). Dejar el texto:

Plan activo: Pro (cancelaciÃ³n al final del perÃ­odo) si el backend devuelve cancelAtPeriodEnd: true.

Con 404 o 400: mostrar el mensaje del backend.

5) Pruebas de aceptaciÃ³n

Caso feliz: Usuario con Pro activo pulsa â€œCancelarâ€. Respuesta 200. UI muestra el aviso y no borra el plan activo. En Stripe, la suscripciÃ³n queda cancel_at_period_end = true.

Webhook: simular customer.subscription.deleted. Tras llegar, en DB: active_plan=NULL, credits_renew_at=NULL, stripe_subscription_id=NULL; en UI ya no hay plan activo.

Fallback: Quitar manualmente stripe_subscription_id en DB y volver a cancelar; el backend debe encontrar la suscripciÃ³n listando por stripe_customer_id.

Seguridad: Usuario sin stripe_customer_id recibe 400 y mensaje claro.

No duplicaciÃ³n: Reenviar eventos desde Stripe â†’ sin cambios ni duplicados en crÃ©ditos o estado.

6) Observabilidad

Prefijo de logs consistente: billing> ...

AÃ±adir log al entrar en /api/billing/cancel y tras la respuesta de Stripe.

Mantener trazabilidad en stripe_events.