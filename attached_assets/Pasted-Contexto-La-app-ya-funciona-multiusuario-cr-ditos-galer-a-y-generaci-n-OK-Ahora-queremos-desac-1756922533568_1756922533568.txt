Contexto

La app ya funciona: multiusuario, cr√©ditos, galer√≠a y generaci√≥n OK.

Ahora queremos desacoplar totalmente Replit Auth para que SIEMPRE se use el sistema propio de email/contrase√±a, tanto en Preview como en deploy.

Mant√©n compatibilidad con usuarios ya creados (v√≠a Replit o locales).

üõ°Ô∏è Regla de oro

No rompas nada que ya funciona.
Nada de regresiones en generaci√≥n de videos, cr√©ditos, sesi√≥n, rutas o UI. Si algo depende de Replit Auth, debe tener un reemplazo equivalente con el sistema local.

‚úÖ Instrucciones
1) Desactivar Replit Auth (backend)

Elimina/Desmonta cualquier middleware, inicializaci√≥n o rutas de Replit Auth:

No montes rutas tipo /api/login / /api/callback de Replit.

No uses passport de Replit en el pipeline.

Deja activo solo express-session con connect-pg-simple (ya lo estamos usando):

Confirma que la cookie y la store en Postgres siguen activas.

isAuthenticated: Aseg√∫rate de que la versi√≥n local valida req.session.user (no tokens de Replit).

CORS y cookies:

Habilita credentials: true en el servidor y withCredentials en el cliente.

cookie con sameSite: "lax" en desarrollo y secure: true + sameSite: "none" en producci√≥n con HTTPS.

2) Modo de autenticaci√≥n: solo local

A√±ade variable de control: AUTH_PROVIDER=local.

Si local, nunca renderices botones de Replit ni llames a endpoints de Replit.

Endpoints activos (ya existen, solo asegurar wiring):

POST /api/auth/register ‚Üí crea usuario con password_hash (argon2) + 10 cr√©ditos de bienvenida.

POST /api/auth/login ‚Üí valida credenciales, establece req.session.user.

POST /api/auth/logout ‚Üí destruye sesi√≥n.

GET /api/auth/user ‚Üí devuelve el perfil del usuario autenticado.

Rate limiting:

Mant√©n 10 intentos/10min para /login y /register.

3) Migraci√≥n de usuarios Replit (compatibilidad)

No borres columnas/filas existentes.

Si existe usuario con email previo (creado por Replit) y no tiene password_hash:

Permite ‚ÄúEstablecer contrase√±a‚Äù desde Mi Cuenta ‚Üí crea password_hash y a partir de ah√≠ ya entra solo con email/contrase√±a.

Primera vinculaci√≥n: si intenta login local con email que existe sin password_hash, devuelve mensaje:
‚ÄúEsta cuenta se cre√≥ con otro m√©todo. Establece una contrase√±a en Mi Cuenta.‚Äù

4) UI (frontend)

Sidebar / Header:

Reemplaza ‚ÄúEntrar con Replit‚Äù por un bot√≥n ‚ÄúEntrar / Registrarse‚Äù que abre el modal propio.

Cuando hay sesi√≥n: muestra avatar + men√∫ (Mi cuenta, Cerrar sesi√≥n).

Modal Auth propio (ya lo tienes):

Tabs: Iniciar sesi√≥n | Crear cuenta.

Validaci√≥n en cliente + mensajes claros.

Mi Cuenta:

Mantener: nombre, apellidos, avatar, cr√©ditos.

A√±adir/Confirmar: secci√≥n Cambiar contrase√±a y si el usuario viene de Replit sin pass, bot√≥n Establecer contrase√±a (usa el mismo flujo).

Protecci√≥n de acciones:

Si no hay sesi√≥n ‚Üí bloquea generaci√≥n y abre modal auth.

Indicador de cr√©ditos sigue visible.

5) Variables de entorno

Quitar claves de Replit Auth si exist√≠an (o ignorarlas).

Mantener/a√±adir:

AUTH_PROVIDER=local

SESSION_SECRET=<tu_secret_seguro>

BASE_URL=<url p√∫blica o preview>

DATABASE_URL (Neon)

(Opcional prod) COOKIE_SECURE=true, COOKIE_SAMESITE=none

No pidas claves de Google/GitHub ahora (lo haremos m√°s adelante).

6) Seguridad

Hash con argon2 y validaciones robustas (min longitudes, emails, etc).

CSRF opcional: si ya tienes SameSite correcto, posponer; no lo introduzcas si complica cookies ahora.

XSS/escape en formularios.

No expongas password_hash ni datos sensibles en /api/auth/user.

7) Pruebas de humo (debe pasar todo)

Con AUTH_PROVIDER=local, no aparece el popup de Replit ni botones de Replit.

Registro con email/contrase√±a ‚Üí sesi√≥n creada + 10 cr√©ditos ‚Üí dashboard muestra cr√©ditos.

Login/Logout funcionan (la cookie se borra) sin errores.

‚ÄúMi Cuenta‚Äù permite cambiar contrase√±a y establecer contrase√±a si ven√≠as de Replit.

Generar video: descuenta 1 cr√©dito y respeta aislamiento por usuario.

Galer√≠a: cada usuario ve solo sus videos.

Webhooks de Kie.ai siguen aterrizando y relacionando por user_id correcto.

8) Despliegue

En Vercel u otro hosting, asegura:

SESSION_SECRET definido.

Dominio HTTPS para secure cookies.

CORS/credentials OK entre front y API.

Configura AUTH_PROVIDER=local en el entorno de producci√≥n.

9) Rollback plan

Si algo falla: poner AUTH_PROVIDER=replit y volver a montar las rutas Replit (sin borrar nada local).

Mant√©n el c√≥digo de Replit Auth aislado detr√°s de la variable de entorno para alternar r√°pido si es necesario.