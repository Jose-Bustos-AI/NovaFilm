Objetivo

Mostrar el plan activo del usuario (Basic/Pro/Max) con fecha de renovaciÃ³n y un botÃ³n para cancelar la suscripciÃ³n, manteniendo toda la lÃ³gica de crÃ©ditos y webhook tal como estÃ¡.

ğŸ§± Regla de oro

No tocar login ni consumo de crÃ©ditos.

No regalar crÃ©ditos ni recontarlos al actualizar el plan.

Webhook sigue sumando crÃ©ditos solo con invoice.payment_succeeded y con idempotencia por invoice.id.

Si hay dudas en el webhook: log + 200 OK, pero sin cambiar crÃ©ditos.

âœ… Lo que hay que aÃ±adir/arreglar
1) Persistencia mÃ­nima (tabla users)

AsegÃºrate de que estos campos existen y se actualizan:

users.active_plan â†’ basic | pro | max (string)

users.credits_renew_at â†’ timestamp (fin del perÃ­odo de facturaciÃ³n)

users.stripe_customer_id â†’ ya lo tenemos

users.stripe_subscription_id â†’ nuevo (string, nullable)

Si no existe stripe_subscription_id, aÃ±Ã¡delo.

2) Webhook â€” mantener plan y renovaciÃ³n

En el manejador de invoice.payment_succeeded (donde ya sumamos crÃ©ditos):

Determinar el priceId y mapear a basic | pro | max (ya lo hacÃ©is).

Actualizar (sin tocar crÃ©ditos):

users.active_plan = <basic|pro|max>

users.credits_renew_at = current_period_end

Sacar de invoice.lines.data[0].period.end o expandiendo la subscription.

users.stripe_subscription_id = <subscriptionId> (si viene en el evento)

No crear nuevos asientos de crÃ©ditos aquÃ­ si ya se sumaron para ese invoice.id (idempotencia intacta).

Procesar ademÃ¡s:

customer.subscription.deleted â†’ poner:

users.active_plan = null

users.credits_renew_at = null

(no tocar crÃ©ditos ya concedidos)

(Opcional) customer.subscription.updated â†’ si cambia cancel_at_period_end, reflejarlo.

Logs (prefijo billing>):

billing> PLAN SET: plan=<basic|pro|max> renewAt=<ISO> sub=<sub_...> user=<id>

billing> PLAN CLEARED (subscription deleted) user=<id>

3) Endpoints de estado y acciones
GET /api/billing/subscription

Responde con:

{
  "activePlan": "pro" | "basic" | "max" | null,
  "renewAt": "2025-10-04T10:00:00Z" | null,
  "status": "active" | "canceled" | "none",
  "cancelAtPeriodEnd": true | false,
  "manageUrl": "<opcional para portal de Stripe>"
}


Derivar status asÃ­:

active_plan != null â†’ "active"

active_plan == null â†’ "none"

(si en Stripe viene cancel_at_period_end=true) â†’ "active" pero mostrar â€œse cancelarÃ¡ el â€¦â€.

POST /api/billing/cancel

Requiere usuario autenticado.

Busca users.stripe_subscription_id; si no hay, error amable.

Llama a Stripe para marcar cancel_at_period_end = true.

Devuelve { ok: true, cancelAtPeriodEnd: true }.

No tocar crÃ©ditos.

(Opcional) POST /api/billing/reactivate para quitar cancel_at_period_end.

4) UI â€œMi Cuentaâ€

Bloque â€œPlanes y SuscripciÃ³nâ€:

Si activePlan != null:

Mostrar â€œPlan activo: Basic/Pro/Maxâ€

â€œRenueva el: <fecha local corta>â€ (de renewAt)

BotÃ³n â€œCancelar suscripciÃ³nâ€ â†’ llama a POST /api/billing/cancel

Si cancelAtPeriodEnd=true, mostrar aviso â€œSe cancelarÃ¡ el <fecha>â€

Si activePlan == null:

Mostrar â€œSin suscripciÃ³n activaâ€ (como ahora) y las tarjetas de planes.

Importante: no sumar crÃ©ditos desde UI; UI solo refleja GET /api/billing/subscription.

5) Reconcilia lo ya vendido (backfill suave)

Para usuarios con compras ya realizadas:

Si tienen stripe_customer_id y algÃºn invoice.payment_succeeded reciente, pero active_plan es null: llamar a Stripe (subscription del customer) y rellenar active_plan, credits_renew_at, stripe_subscription_id sin tocar crÃ©ditos.

Esto puede ser un script puntual o endpoint admin.

6) Pruebas de aceptaciÃ³n (QA)

Compra PRO en test:

CrÃ©ditos +12 una sola vez (ya ok).

GET /api/billing/subscription devuelve { activePlan: "pro", renewAt: <fecha> }.

UI muestra â€œPlan activo: Proâ€ y â€œRenueva el: â€¦â€.

Pulsar â€œCancelar suscripciÃ³nâ€:

En Stripe: cancel_at_period_end=true.

GET /api/billing/subscription refleja cancelAtPeriodEnd: true.

UI muestra aviso â€œSe cancelarÃ¡ el â€¦â€.

CrÃ©ditos existentes intactos.

Enviar customer.subscription.deleted desde Stripe:

UI pasa a â€œSin suscripciÃ³n activaâ€.

CrÃ©ditos histÃ³ricos intactos.

âœ… Resultado esperado

La suscripciÃ³n queda activa y visible tras cada pago.

Se muestra la fecha de renovaciÃ³n.

El usuario puede cancelar sin afectar sus crÃ©ditos.

Webhook sigue siendo idempotente y solo suma con invoice.payment_succeeded.

Con esto deberÃ­a desaparecer el â€œSin suscripciÃ³n activaâ€ y verÃ¡s el plan + renovaciÃ³n + botÃ³n de cancelaciÃ³n