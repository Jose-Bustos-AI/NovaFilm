Contexto (quÃ© queremos)

Tenemos NovaFilm v2 con multiusuario y sistema de crÃ©ditos.
Ahora vamos a integrar Stripe (suscripciones) con 3 planes:

BASIC â†’ 4.97â‚¬ / mes â†’ 5 crÃ©ditos/mes

PRO â†’ 9.97â‚¬ / mes â†’ 12 crÃ©ditos/mes

MAX â†’ 19.97â‚¬ / mes â†’ 30 crÃ©ditos/mes

Regla de negocio: 1 crÃ©dito = 1 vÃ­deo.
Cuando Stripe confirme un pago, debemos sumar los crÃ©ditos que correspondan al usuario.
Sin regalo de crÃ©ditos al registrarse.
Nada de romper lo que ya funciona (dashboard, generaciÃ³n, galerÃ­a, chat, etc.).

ğŸ§± Regla de oro (NO romper lo existente)

No tocar la lÃ³gica de generaciÃ³n ni el descuento de crÃ©ditos actual.

AÃ±adir la capa de pagos encapsulada (rutas nuevas + columnas nuevas).

Si hay cualquier duda, mantener el comportamiento actual por defecto.

ğŸ” Variables/Secrets necesarias (aÃ±Ã¡delas en el panel de secretos)

STRIPE_SECRET_KEY â†’ clave privada de Stripe (modo test por ahora).

STRIPE_WEBHOOK_SECRET â†’ firma del webhook que Stripe te darÃ¡ al crearlo.

STRIPE_PRICE_BASIC â†’ price_id del plan Basic (Stripe > Products > Price ID).

STRIPE_PRICE_PRO â†’ price_id del plan Pro.

STRIPE_PRICE_MAX â†’ price_id del plan Max.

APP_BASE_URL â†’ URL pÃºblica del frontend (la de Replit), para redirigir Ã©xito/cancel.

(Yo ya tengo los productos; te paso los 3 price_id cuando lo pidas.)

ğŸ—„ï¸ Cambios de base de datos (mÃ­nimos y seguros)

AÃ±adir columnas en users (no romper nada):

stripe_customer_id text NULL

active_plan text NULL â€” valores: basic | pro | max | null

credits_renew_at timestamptz NULL â€” prÃ³ximo momento de renovaciÃ³n (opcional)

Nueva tabla stripe_events (para idempotencia):

id text primary key (Stripe event id)

type text

payload jsonb

created_at timestamptz default now()

Si ya tenemos migrador, crear una migraciÃ³n. Si no, ejecutar alter table con cuidado.

ğŸ§© LÃ³gica/Endpoints a implementar
1) GET /api/billing/plans

Devuelve al frontend los planes disponibles y sus price_id + crÃ©ditos:

[
  {"key":"basic","priceId":STRIPE_PRICE_BASIC,"price":4.97,"credits":5},
  {"key":"pro","priceId":STRIPE_PRICE_PRO,"price":9.97,"credits":12},
  {"key":"max","priceId":STRIPE_PRICE_MAX,"price":19.97,"credits":30}
]

2) POST /api/billing/checkout

Body: { planKey: "basic" | "pro" | "max" }

Requiere usuario logueado (usar sesiÃ³n actual).

Si el usuario no tiene stripe_customer_id, crear Customer en Stripe con:

email

metadata.userId = <id interno>

Crear Checkout Session (mode: subscription) con el price_id del plan.

success_url = ${APP_BASE_URL}/account?status=success

cancel_url = ${APP_BASE_URL}/account?status=cancel

Devolver { url } para redirigir al checkout.

3) POST /api/stripe/webhook

Verificar firma con STRIPE_WEBHOOK_SECRET.

Registrar todos los eventos en stripe_events (idempotencia: si ya existe, ignorar).

Manejar (mÃ­nimo):

checkout.session.completed

Guardar stripe_customer_id si no lo tenÃ­amos.

invoice.paid (el importante)

Leer el subscription â†’ items[0].price.id

Mapear a plan:
STRIPE_PRICE_BASIC â†’ credits = 5,
STRIPE_PRICE_PRO â†’ 12,
STRIPE_PRICE_MAX â†’ 30

Buscar usuario por customer (customerId â†” user.stripe_customer_id).

Sumar crÃ©ditos en users.credits = credits + planCredits.

Actualizar active_plan y opcional credits_renew_at con current_period_end.

customer.subscription.deleted

Poner active_plan = null (no quitar crÃ©ditos existentes).

Seguridad & robustez

Idempotencia estricta por event.id.

Si no se encuentra el usuario por customer, loggear y no fallar el 200 al webhook.

Nunca restar crÃ©ditos en webhooks.

ğŸ–¥ï¸ UI/Frontend (mÃ­nimo necesario)

En Mi Cuenta:

Nueva secciÃ³n â€œPlanes y SuscripciÃ³nâ€ con los 3 planes (precio y crÃ©ditos).

BotÃ³n â€œSuscribirmeâ€ â†’ llama a /api/billing/checkout y redirige a url.

Mostrar active_plan si existe y crÃ©ditos actuales (ya existen).

Si active_plan es null â†’ â€œSin suscripciÃ³n activaâ€.

Notificar en UI ?status=success o ?status=cancel.

No tocar dashboard ni galerÃ­a. Solo aÃ±adir el bloque de planes en Mi Cuenta.

ğŸ§ª Pruebas (pasos claros)

Crear 1 usuario nuevo (sin Stripe) â†’ credits iniciales: 0 (ya SIN regalo).

Ir a Mi Cuenta â†’ ver 3 planes.

Suscribirse a PRO â†’ pagar con tarjeta de prueba (4242â€¦).

Esperar webhook invoice.paid â†’ comprobar que:

users.credits aumenta en 12.

users.active_plan = 'pro'.

users.stripe_customer_id estÃ¡ guardado.

Generar 1 vÃ­deo â†’ credits baja en 1 (lÃ³gica actual).

Cancelar suscripciÃ³n desde Stripe â†’ recibir customer.subscription.deleted â†’ active_plan = null (crÃ©ditos quedan).

Intentar suscribir al mismo usuario a MAX â†’ checkout funciona y al pagarse suma 30.

âœ… Entregables

Rutas nuevas funcionando: /api/billing/plans, /api/billing/checkout, /api/stripe/webhook.

MigraciÃ³n DB aplicada (o cambios seguros realizados).

UI de planes en â€œMi Cuentaâ€.

DocumentaciÃ³n rÃ¡pida en README con:

Secrets necesarios

URL de webhook para Stripe:
https://<tu-repl>.replit.dev/api/stripe/webhook

Mapa price_id â†’ planKey â†’ crÃ©ditos